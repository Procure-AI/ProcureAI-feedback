name: Sync Issues to Backend Repo

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created]

jobs:
  sync-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Sync to Backend Repository
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BACKEND_SYNC_TOKEN }}
          script: |
            const feedbackIssue = context.payload.issue;
            const action = context.payload.action;

            // Reference to the backend repo
            const backendOwner = 'Procure-AI';
            const backendRepo = 'ProcureAI-backend';

            // Create a reference ID to track synced issues
            const feedbackIssueUrl = feedbackIssue.html_url;
            const syncTag = `\n\n---\n**External Submission:** [${feedbackIssue.number}](${feedbackIssueUrl})`;

            // Search for existing synced issue in backend repo
            const searchQuery = `repo:${backendOwner}/${backendRepo} is:issue "${feedbackIssue.title}"`;
            const existingIssues = await github.rest.search.issuesAndPullRequests({
              q: searchQuery,
            });

            let backendIssue = existingIssues.data.items.find(issue =>
              issue.body && issue.body.includes(feedbackIssueUrl)
            );

            if (action === 'opened') {
              // Create new issue in backend repo
              if (!backendIssue) {
                const newIssue = await github.rest.issues.create({
                  owner: backendOwner,
                  repo: backendRepo,
                  title: feedbackIssue.title,
                  body: feedbackIssue.body + syncTag,
                  labels: ['external', 'backlog', ...feedbackIssue.labels.map(l => l.name)],
                });

                backendIssue = newIssue.data;

                // Comment on feedback issue with link to backend issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: feedbackIssue.number,
                  body: `âœ… This has been added to our internal backlog: #${backendIssue.number}\n\nWe'll keep you updated on progress!`,
                });

                core.info(`Created backend issue #${backendIssue.number}`);
              }
            } else if (action === 'edited' && backendIssue) {
              // Update existing backend issue
              await github.rest.issues.update({
                owner: backendOwner,
                repo: backendRepo,
                issue_number: backendIssue.number,
                title: feedbackIssue.title,
                body: feedbackIssue.body + syncTag,
              });

              core.info(`Updated backend issue #${backendIssue.number}`);
            } else if (action === 'closed' && backendIssue && feedbackIssue.state === 'closed') {
              // Close backend issue when feedback issue is closed
              await github.rest.issues.update({
                owner: backendOwner,
                repo: backendRepo,
                issue_number: backendIssue.number,
                state: 'closed',
              });

              await github.rest.issues.createComment({
                owner: backendOwner,
                repo: backendRepo,
                issue_number: backendIssue.number,
                body: `Closed via external feedback: ${feedbackIssueUrl}`,
              });

              core.info(`Closed backend issue #${backendIssue.number}`);
            } else if (action === 'reopened' && backendIssue) {
              // Reopen backend issue
              await github.rest.issues.update({
                owner: backendOwner,
                repo: backendRepo,
                issue_number: backendIssue.number,
                state: 'open',
              });

              core.info(`Reopened backend issue #${backendIssue.number}`);
            } else if ((action === 'labeled' || action === 'unlabeled') && backendIssue) {
              // Sync labels
              const currentLabels = feedbackIssue.labels.map(l => l.name);
              await github.rest.issues.setLabels({
                owner: backendOwner,
                repo: backendRepo,
                issue_number: backendIssue.number,
                labels: ['external', 'backlog', ...currentLabels],
              });

              core.info(`Updated labels on backend issue #${backendIssue.number}`);
            }
